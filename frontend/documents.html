<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Documents - Document Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .documents-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .document-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .view-btn, .delete-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .view-btn {
            background: #28a745;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .error-message {
            color: #dc3545;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            color: #28a745;
            margin: 10px 0;
            display: none;
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
        }

        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .drop-zone:hover {
            background: #e9ecef;
        }

        .drop-zone.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="user-info">
            <h2>Welcome, <span id="user-name"></span></h2>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <div class="main-container">
        <div class="drop-zone" id="drop-zone">
            <input type="file" id="file-input" accept=".txt,.pdf" style="display: none;">
            <p>Drop your document here or click to upload</p>
            <p class="small">Supported formats: PDF, TXT</p>
        </div>
        <div id="error-message" class="error-message"></div>
        <div id="documents-list" class="documents-list"></div>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Load user info
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            document.getElementById('user-name').textContent = `${user.firstName} ${user.lastName}`;
        }

        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        // Setup file upload handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', handleFileDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            if (!file) return;

            const allowedTypes = ['application/pdf', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                document.getElementById('error-message').textContent = 'Only PDF and TXT files are supported';
                document.getElementById('error-message').style.display = 'block';
                return;
            }

            try {
                let content;
                if (file.type === 'application/pdf') {
                    content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                } else {
                    content = await readTextFile(file);
                }
                uploadDocument(file, content);
            } catch (error) {
                console.error('Error processing file:', error);
                document.getElementById('error-message').textContent = 'Error processing file: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Error reading file'));
                reader.readAsText(file);
            });
        }

        function uploadDocument(file, content) {
            const token = localStorage.getItem('token');
            
            // Show loading state
            const documentsList = document.getElementById('documents-list');
            const loadingCard = document.createElement('div');
            loadingCard.className = 'document-card';
            loadingCard.innerHTML = `
                <h3>${file.name}</h3>
                <p><span class="loading-spinner"></span>Uploading...</p>
            `;
            documentsList.insertBefore(loadingCard, documentsList.firstChild);

            fetch('http://localhost:5001/api/documents', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data._id) {
                    // Create a simple card without preview
                    const card = document.createElement('div');
                    card.className = 'document-card';
                    card.innerHTML = `
                        <h3>${data.fileName}</h3>
                        <p>Size: ${formatFileSize(data.fileSize)}</p>
                        <p>Type: ${data.fileType}</p>
                        <div class="document-actions">
                            <button class="view-btn" onclick="viewDocument('${data._id}')">View Document</button>
                            <button class="delete-btn" onclick="deleteDocument('${data._id}')">Delete</button>
                        </div>
                    `;
                    
                    // Replace loading card with new card
                    documentsList.replaceChild(card, loadingCard);

                    // Add success message
                    document.getElementById('error-message').className = 'success-message';
                    document.getElementById('error-message').textContent = 'Document uploaded successfully!';
                    document.getElementById('error-message').style.display = 'block';

                    // Hide message after 3 seconds
                    setTimeout(() => {
                        document.getElementById('error-message').style.display = 'none';
                    }, 3000);

                    // Refresh document list
                    loadDocuments();
                } else {
                    throw new Error(data.message || 'Error uploading document');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-message').className = 'error-message';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-message').style.display = 'block';
                if (loadingCard.parentNode) {
                    documentsList.removeChild(loadingCard);
                }
            });
        }

        function viewDocument(id) {
            const token = localStorage.getItem('token');
            // First verify the document exists and is accessible
            fetch(`http://localhost:5001/api/documents/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(document => {
                if (document._id) {
                    window.location.href = `index.html?document=${document._id}`;
                } else {
                    throw new Error('Document not found');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-message').className = 'error-message';
                document.getElementById('error-message').textContent = 'Error accessing document';
                document.getElementById('error-message').style.display = 'block';
            });
        }

        function deleteDocument(id) {
            if (!confirm('Are you sure you want to delete this document?')) return;

            const token = localStorage.getItem('token');
            fetch(`http://localhost:5001/api/documents/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    loadDocuments();
                    document.getElementById('error-message').className = 'success-message';
                    document.getElementById('error-message').textContent = 'Document deleted successfully!';
                    document.getElementById('error-message').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('error-message').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to delete document');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-message').className = 'error-message';
                document.getElementById('error-message').textContent = 'Error deleting document';
                document.getElementById('error-message').style.display = 'block';
            });
        }

        function loadDocuments() {
            const token = localStorage.getItem('token');
            fetch('http://localhost:5001/api/documents', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(documents => {
                const documentsList = document.getElementById('documents-list');
                documentsList.innerHTML = '';
                documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'document-card';
                    card.innerHTML = `
                        <h3>${doc.fileName}</h3>
                        <p>Size: ${formatFileSize(doc.fileSize)}</p>
                        <p>Type: ${doc.fileType}</p>
                        <div class="document-actions">
                            <button class="view-btn" onclick="viewDocument('${doc._id}')">View Document</button>
                            <button class="delete-btn" onclick="deleteDocument('${doc._id}')">Delete</button>
                        </div>
                    `;
                    documentsList.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-message').className = 'error-message';
                document.getElementById('error-message').textContent = 'Error loading documents';
                document.getElementById('error-message').style.display = 'block';
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Load documents when page loads
        loadDocuments();
    </script>
</body>
</html>
