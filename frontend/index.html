<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document Analysis - Document Analyzer</title>
        <!-- PDF.js for PDF processing -->
        <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
        <!-- puter.ai library for AI summarization and chat -->
        <script src="https://js.puter.com/v2/"></script>
        <style>
            /* Global Styles */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background-color: #f5f5f5;
                min-height: 100vh;
                padding: 20px;
            }

            .navbar {
                background: white;
                padding: 15px 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                border-radius: 8px;
            }

            .navbar .nav-links a,
            .navbar .logout-btn {
                margin-left: 15px;
                text-decoration: none;
                color: #333;
            }

            .main-container {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
                height: calc(100vh - 100px);
            }

            /* Left Column (Document Section) */
            .document-section {
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow-y: auto;
            }

            /* Upload Area – always visible */
            #upload-section {
                border: 2px dashed #3498db;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                margin-bottom: 20px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            #upload-section:hover {
                background: #e9ecef;
            }

            #upload-section.dragover {
                background: #e3f2fd;
                border-color: #1565c0;
            }

            #upload-section button {
                margin-top: 10px;
                padding: 8px 16px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            /* Dropdown Menu for Document Selection */
            #document-dropdown-container {
                margin-bottom: 20px;
            }

            #document-select {
                padding: 8px;
                font-size: 14px;
                width: 60%;
            }

            #document-dropdown-container button {
                padding: 8px 16px;
                margin-left: 10px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #view-selected-btn {
                background: #28a745;
                color: white;
            }

            #delete-selected-btn {
                background: #dc3545;
                color: white;
            }

            /* Document Content */
            #document-content {
                flex-grow: 1;
                overflow-y: auto;
                background: #f8f9fa;
                border-radius: 4px;
                border: 1px solid #dee2e6;
                padding: 10px;
            }

            .pdf-page {
                margin: 10px auto;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                width: 100%;
                height: auto;
            }

            .document-text {
                padding: 20px;
                line-height: 1.6;
                white-space: pre-wrap;
            }

            /* Chat Section (Right Column) */
            .chat-wrapper {
                height: 700px;
                display: flex;
                flex-direction: column;
            }

            .score-section {
                background: #e3f2fd;
                padding: 10px;
                border-radius: 4px;
                text-align: center;
                margin-bottom: 10px;
                height: 50px;
                line-height: 30px;
            }

            .chat-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            .chat-header {
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
                margin-bottom: 15px;
            }

            .chat-header h3 {
                margin-bottom: 5px;
            }

            .chat-area {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .message {
                padding: 10px 15px;
                border-radius: 8px;
                max-width: 80%;
                word-wrap: break-word;
            }

            .user-message {
                background: #007bff;
                color: white;
                align-self: flex-end;
            }

            .ai-message {
                background: #f0f0f0;
                color: #333;
                align-self: flex-start;
            }

            .chat-input-container {
                display: flex;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #eee;
                margin-top: auto;
            }

            .chat-input {
                flex-grow: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .send-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
            }

            .loading,
            .error-message,
            .success-message {
                text-align: center;
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }

            .error-message {
                color: #dc3545;
                background: #f8d7da;
            }

            .success-message {
                color: #28a745;
                background: #d4edda;
            }

            @media (max-width: 1024px) {
                .main-container {
                    grid-template-columns: 1fr;
                }

                .chat-wrapper {
                    height: 500px;
                }
            }
        </style>
    </head>

    <body>
        <div class="navbar">
            <div class="user-info">
                <h2>Document Analysis</h2>
            </div>
            <div class="nav-links">
                <a href="documents.html">My Documents</a>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div class="main-container">
            <div class="document-section">
                <!-- Upload Area (always visible) -->
                <div id="upload-section">
                    <p>Drop your document here or click to upload</p>
                    <input type="file" id="file-input" accept=".pdf,.txt" style="display: none;">
                    <button onclick="document.getElementById('file-input').click()">Choose File</button>
                </div>
                <!-- Dropdown Menu for Document Selection -->
                <div id="document-dropdown-container" style="margin-bottom: 20px; display: none;">
                    <select id="document-select">
                        <option value="">Select a document</option>
                    </select>
                    <button id="view-selected-btn">View Document</button>
                    <button id="delete-selected-btn">Delete Document</button>
                </div>
                <!-- Document Content Display -->
                <div id="document-content">
                    <!-- Rendered PDF pages or text content appear here -->
                </div>
            </div>
            <div class="chat-wrapper">
                <div id="score-section" class="score-section">Compliance Score: --</div>
                <div class="chat-content">
                    <div class="chat-header">
                        <h3>AI Assistant</h3>
                        <p>Ask questions about your document</p>
                    </div>
                    <div id="chat-area" class="chat-area">
                        <div class="ai-message">
                            Hello! I'm your AI assistant. Upload a document and I'll help you analyze it.
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type your message...">
                        <button id="send-btn" class="send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Set up PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

            // Global variables
            let documentData = null; // { fileName, fullText }
            let currentFile = null;

            // DOM Elements
            const uploadSection = document.getElementById('upload-section');
            const fileInput = document.getElementById('file-input');
            const documentContent = document.getElementById('document-content');
            const dropdownContainer = document.getElementById('document-dropdown-container');
            const documentSelect = document.getElementById('document-select');
            const viewSelectedBtn = document.getElementById('view-selected-btn');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const chatArea = document.getElementById('chat-area');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');

            // File upload handling
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            });

            async function processFile(file) {
                if (!['application/pdf', 'text/plain'].includes(file.type)) {
                    alert('Only PDF and TXT files are supported.');
                    return;
                }
                currentFile = file;
                if (file.type === 'application/pdf') {
                    // Render immediately using an object URL
                    const fileURL = URL.createObjectURL(file);
                    renderPdf(fileURL);
                    const reader = new FileReader();
                    reader.onload = async function () {
                        try {
                            const text = await extractPdfText(file);
                            // Store file name and full text for chat context
                            documentData = { fileName: file.name, fullText: text };
                            const doc = await uploadDocument(file, reader.result);
                            // Save current document ID for persistence
                            localStorage.setItem('currentDocument', doc._id);
                            window.history.replaceState(null, "", `?document=${doc._id}`);
                            addMessage(`Document "${file.name}" uploaded successfully.`, true);
                            // Refresh the dropdown menu to include this document
                            loadDocumentsDropdown(doc._id);
                        } catch (err) {
                            addMessage(`Error processing document: ${err}`, true);
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'text/plain') {
                    file.text().then(async (text) => {
                        documentContent.innerHTML = `<div class="document-text">${text}</div>`;
                        documentData = { fileName: file.name, fullText: text };
                        const doc = await uploadDocument(file, text);
                        localStorage.setItem('currentDocument', doc._id);
                        window.history.replaceState(null, "", `?document=${doc._id}`);
                        addMessage(`Document "${file.name}" uploaded successfully.`, true);
                        loadDocumentsDropdown(doc._id);
                    }).catch(err => {
                        addMessage(`Error reading document: ${err}`, true);
                    });
                }
            }

            async function uploadDocument(file, dataURL) {
                const token = localStorage.getItem('token');
                let contentToSend = dataURL;
                if (file.type === 'application/pdf') {
                    const prefix = "data:application/pdf;base64,";
                    if (dataURL.startsWith(prefix)) {
                        contentToSend = dataURL.slice(prefix.length);
                    }
                }
                const payload = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    content: contentToSend
                };
                const res = await fetch('http://localhost:5001/api/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Error uploading document');
                return await res.json();
            }

            async function extractPdfText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async function () {
                        try {
                            const typedarray = new Uint8Array(reader.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                const strings = content.items.map(item => item.str);
                                fullText += strings.join(' ') + "\n\n";
                            }
                            resolve(fullText);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(reader.error);
                    reader.readAsArrayBuffer(file);
                });
            }

            async function renderPdf(url) {
                const container = document.getElementById('document-content');
                container.innerHTML = '<div id="pdf-container"></div>';
                const pdfContainer = document.getElementById('pdf-container');
                try {
                    const pdf = await pdfjsLib.getDocument(url).promise;
                    const numPages = pdf.numPages;
                    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        canvas.className = 'pdf-page';
                        pdfContainer.appendChild(canvas);
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                    }
                } catch (error) {
                    console.error('Error rendering PDF:', error);
                    container.innerHTML = '<div class="error-message">Error rendering PDF. Please try again.</div>';
                }
            }

            async function extractPdfTextFromBuffer(buffer) {
                const typedarray = new Uint8Array(buffer);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    fullText += strings.join(' ') + "\n\n";
                }
                return fullText;
            }

            // Load a document from the server by its ID
            async function loadDocumentFromServer(docId) {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch(`http://localhost:5001/api/documents/${docId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Document not found');
                    const doc = await response.json();
                    documentData = { fileName: doc.fileName, fullText: '', content: doc.content };
                    if (doc.fileType === 'application/pdf') {
                        const dataURL = `data:application/pdf;base64,${doc.content}`;
                        renderPdf(dataURL);
                        try {
                            const arrayBuffer = await fetch(dataURL).then(res => res.arrayBuffer());
                            const text = await extractPdfTextFromBuffer(arrayBuffer);
                            documentData.fullText = text;
                            addMessage(`Document "${doc.fileName}" loaded.`, true);
                        } catch (err) {
                            addMessage(`Error analyzing document: ${err}`, true);
                        }
                    } else {
                        document.getElementById('document-content').innerHTML = `<div class="document-text">${doc.content}</div>`;
                        documentData.fullText = doc.content;
                        addMessage(`Document "${doc.fileName}" loaded.`, true);
                    }
                } catch (error) {
                    addMessage(`Error loading document: ${error}`, true);
                    document.getElementById('document-content').innerHTML = `<div class="error-message">Failed to load document.</div>`;
                }
            }

            // Populate the dropdown with documents from the server
            async function loadDocumentsDropdown(selectedId = "") {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('http://localhost:5001/api/documents', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const docs = await response.json();
                    const selectEl = document.getElementById('document-select');
                    selectEl.innerHTML = '<option value="">Select a document</option>';
                    docs.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc._id;
                        option.textContent = doc.fileName;
                        if (doc._id === selectedId) {
                            option.selected = true;
                        }
                        selectEl.appendChild(option);
                    });
                    // Show the dropdown container if documents exist
                    dropdownContainer.style.display = docs.length > 0 ? 'block' : 'none';
                } catch (error) {
                    console.error("Error loading dropdown:", error);
                }
            }

            // Event listeners for dropdown buttons
            viewSelectedBtn.addEventListener("click", async () => {
                const selectedId = documentSelect.value;
                if (!selectedId) {
                    alert("Please select a document.");
                    return;
                }
                window.history.replaceState(null, "", `?document=${selectedId}`);
                await loadDocumentFromServer(selectedId);
            });

            deleteSelectedBtn.addEventListener("click", async () => {
                const selectedId = documentSelect.value;
                if (!selectedId) {
                    alert("Please select a document.");
                    return;
                }
                if (!confirm("Are you sure you want to delete this document?")) return;
                const token = localStorage.getItem('token');
                try {
                    const res = await fetch(`http://localhost:5001/api/documents/${selectedId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error("Failed to delete document");
                    addMessage("Document deleted successfully.", true);
                    // If the deleted document is currently viewed, clear the viewer
                    const currentDoc = new URLSearchParams(window.location.search).get("document");
                    if (currentDoc === selectedId) {
                        documentContent.innerHTML = "";
                        documentData = null;
                    }
                    loadDocumentsDropdown();
                } catch (error) {
                    console.error("Error deleting document:", error);
                    alert("Error deleting document");
                }
            });

            // Chat functionality
            function addMessage(message, isAi = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
                const formatted = String(message || '')
                if (isAi) {
                  const formatted = String(message || '')
                    .trim()
                    .replace(/(?:\n\s*){2,}/g, '\n\n') // normalize double spacing
                    .replace(/^\s*[-*•]\s/gm, '• ')    // normalize bullets
                    .replace(/\n/g, '<br>');           // convert newlines to HTML line breaks
                  messageDiv.innerHTML = formatted;
                } else {
                    messageDiv.textContent = String(message || '');
                }
                chatArea.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            sendBtn.addEventListener('click', async () => {
                const message = chatInput.value.trim();
                if (!message) return;
                addMessage(message);
                chatInput.value = '';
                let prompt = "User: " + message;
                if (documentData && documentData.fullText) {
                    prompt += "\nUsing the uploaded document (" + documentData.fileName + ") as reference:\n" + documentData.fullText;
                }
                prompt += "\nProvide a helpful and context-aware response.";
                try {
                    const response = await puter.ai.chat(prompt);
                    addMessage(response, true);
                } catch (err) {
                    addMessage("Error processing your message: " + err, true);
                }
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });

            // On DOMContentLoaded, check for a document query parameter or load the dropdown.
            document.addEventListener("DOMContentLoaded", () => {
                const urlParams = new URLSearchParams(window.location.search);
                let documentId = urlParams.get('document');
                if (documentId) {
                    loadDocumentFromServer(documentId);
                    loadDocumentsDropdown(documentId);
                } else {
                    loadDocumentsDropdown();
                }
            });

            function handleLogout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        </script>
    </body>

</html>